# 功能規格: 動態地點類型系統

**功能分支**: `007-dynamic-location-types`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "實作動態地點類型系統,讓管理員可以自由新增地點分類(如團集會、綠生活)、配置每種類型的專屬欄位、選擇圖示與顏色,並在地圖上以不同視覺呈現"

## Clarifications

### Session 2025-12-02

- Q: 建立動態欄位時,fieldId 應該如何產生? → A: 系統根據欄位標籤自動產生 fieldId(例如:「容納人數」→ `capacity`),但允許管理員編輯以確保語義化與避免衝突
- Q: 對於現有沒有 typeId 欄位的地點,應該如何處理? → A: 建立預設「一般地點」類型,系統自動將所有現有地點的 typeId 遷移到此預設類型,確保向後相容性與資料完整性

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 管理員建立地點類型 (優先順序: P1)

超級管理員希望建立新的地點類型(例如:團集會場地),並為該類型配置專屬欄位,以滿足不同分類的資料需求。

**為何此優先順序**: 這是整個動態類型系統的核心基礎。沒有類型管理功能,後續的類型選擇、動態表單、地圖視覺化都無法實作。

**獨立測試**: 可以透過完整的類型建立流程測試,從填寫表單到資料儲存,驗證類型與欄位配置是否正確儲存到 Firestore。

**驗收場景**:

1. **假設** 超級管理員登入系統, **當** 前往「標籤管理」頁面並點擊「類型管理」標籤, **則** 顯示所有現有地點類型列表
2. **假設** 在類型管理頁面, **當** 點擊「新增類型」按鈕, **則** 顯示類型建立表單,要求輸入:類型名稱、描述、圖示、顏色
3. **假設** 填寫基本資訊, **當** 選擇圖示, **則** 顯示圖示選擇器,包含 50+ 預建 emoji 圖示,依分類(場地🏢、綠生活🌿、環保♻️、活動🎉)分組顯示
4. **假設** 選擇圖示後, **當** 選擇顏色, **則** 顯示顏色選擇器,提供 6 種預設顏色(綠#4CAF50、藍#2196F3、橘#FF9800、粉#E91E63、紫#9C27B0、紅#F44336)或自訂顏色
5. **假設** 基本資訊完成, **當** 進入「欄位配置」區塊, **則** 顯示空白欄位列表與「新增欄位」按鈕
6. **假設** 點擊「新增欄位」, **當** 填寫欄位設定, **則** 要求輸入:欄位 ID、標籤、類型(12+ 種)、是否必填、排序順序、預設值、驗證規則
7. **假設** 選擇欄位類型為「多選下拉選單」, **當** 配置欄位, **則** 額外要求輸入選項列表(選項值與顯示文字)
8. **假設** 新增多個欄位, **當** 調整排序, **則** 支援拖曳排序或上下移動按鈕
9. **假設** 完成所有配置, **當** 提交表單, **則** 儲存到 Firestore `location_types` 集合,並顯示成功訊息與即時預覽
10. **假設** 類型建立成功, **當** 返回列表, **則** 新類型出現在列表中,顯示圖示、名稱、欄位數量、建立時間

---

### 使用者故事 2 - 使用者選擇類型並提交地點 (優先順序: P1)

已登入使用者希望提交地點時先選擇類型,然後填寫該類型的專屬欄位,以提供更詳細的資訊。

**為何此優先順序**: 這是類型系統的核心使用場景,直接影響使用者體驗與資料品質。必須與類型管理同步實作。

**獨立測試**: 可以透過選擇類型並填寫動態表單來完全測試,驗證表單是否根據類型正確生成,且資料正確儲存。

**驗收場景**:

1. **假設** 已登入使用者, **當** 點擊「新增地點」按鈕, **則** 首先顯示「選擇地點類型」步驟
2. **假設** 在類型選擇頁面, **當** 查看選項, **則** 顯示所有啟用的類型,每個類型顯示圖示、名稱、描述
3. **假設** 使用者選擇「團集會場地」類型, **當** 點擊繼續, **則** 進入地點提交表單
4. **假設** 在提交表單, **當** 查看欄位, **則** 顯示共同欄位(名稱、地址、描述、照片)與該類型的專屬欄位(例如:容納人數、可用設備、使用費用、預約方式)
5. **假設** 填寫「容納人數」欄位, **當** 輸入非數字, **則** 即時顯示驗證錯誤「請輸入有效數字」
6. **假設** 填寫「可用設備」欄位(多選), **當** 點擊下拉選單, **則** 顯示預設選項:投影設備、白板、桌椅、廚房,可勾選多個
7. **假設** 完成所有必填欄位, **當** 提交地點, **則** 資料儲存到 Firestore `locations` 集合,包含 `typeId` 與 `dynamicFields` 欄位
8. **假設** 提交成功, **當** 查看確認訊息, **則** 顯示「已提交審核,管理員將在 3 個工作天內處理」

---

### 使用者故事 3 - 地圖上依類型視覺化呈現 (優先順序: P1)

一般訪客希望在地圖上看到不同類型的地點以不同圖示與顏色顯示,並能依類型篩選,以快速找到特定分類的地點。

**為何此優先順序**: 這是類型系統的核心價值體現,直接影響使用者能否有效利用分類功能。必須與前兩個故事同步完成。

**獨立測試**: 可以透過載入地圖並點擊類型篩選來測試,驗證標記是否正確顯示圖示/顏色,篩選是否正常運作。

**驗收場景**:

1. **假設** 訪客開啟地圖頁面, **當** 地圖載入完成, **則** 所有地點標記依其類型顯示對應的圖示與顏色(例如:🏢團集會顯示為綠色,🌿綠生活顯示為淺綠色)
2. **假設** 地圖上有容納人數資訊的團集會場地, **當** 顯示標記, **則** 圖示旁邊顯示人數數字(例如:🏢50 表示可容納 50 人)
3. **假設** 地圖標記眾多且重疊, **當** 縮小地圖, **則** 相近標記自動聚合成群集標記,顯示該區域的類型分布(例如:[ 8 ] 🏢×3 🌿×5)
4. **假設** 訪客想篩選特定類型, **當** 點擊頂部的「🏢 團集會」按鈕, **則** 按鈕高亮,地圖僅顯示團集會類型的標記,其他類型標記隱藏
5. **假設** 已套用類型篩選, **當** 再次點擊相同按鈕或點擊「全部」, **則** 取消篩選,顯示所有類型
6. **假設** 訪客點擊地點標記, **當** 查看詳情面板, **則** 顯示類型圖示、名稱,並顯示該類型的專屬欄位資訊(例如:容納人數、可用設備等)
7. **假設** 詳情面板顯示動態欄位, **當** 欄位類型為「多選」, **則** 以逗號分隔顯示所選項目(例如:「投影設備、白板、桌椅」)
8. **假設** 詳情面板顯示動態欄位, **當** 欄位類型為「布林值」且為 true, **則** 顯示該項目(例如:✅ 提供停車位),若為 false 則不顯示

---

### 使用者故事 4 - 管理員編輯與刪除類型 (優先順序: P2)

超級管理員希望編輯現有類型的欄位配置或刪除不再使用的類型,以持續最佳化資料結構。

**為何此優先順序**: 提供系統彈性與維護能力,但不阻礙初期使用。可在基本類型系統穩定後實作。

**獨立測試**: 可以透過編輯類型並儲存來測試,驗證變更是否正確套用到新提交的地點(不影響現有地點)。

**驗收場景**:

1. **假設** 超級管理員在類型列表, **當** 點擊某個類型的「編輯」按鈕, **則** 進入編輯頁面,預填現有配置
2. **假設** 編輯類型名稱或描述, **當** 儲存變更, **則** 更新 Firestore 文件,所有使用該類型的地點即時反映新名稱
3. **假設** 新增欄位到現有類型, **當** 儲存變更, **則** 新欄位僅對之後提交的地點生效,現有地點不受影響
4. **假設** 刪除類型的某個欄位, **當** 儲存變更, **則** 現有地點保留該欄位資料,但新地點提交表單不再顯示該欄位
5. **假設** 超級管理員想刪除類型, **當** 點擊「刪除」按鈕, **則** 顯示確認對話框「此類型被 X 個地點使用,確定刪除?」
6. **假設** 類型仍被使用, **當** 確認刪除, **則** 可選擇「轉移到其他類型」(選擇目標類型)或「僅停用」(保留現有地點,禁止新提交)
7. **假設** 類型未被任何地點使用, **當** 確認刪除, **則** 直接從 `location_types` 集合刪除

---

### 使用者故事 5 - 管理員審核不同類型地點 (優先順序: P2)

管理員希望在審核地點時查看該類型的專屬欄位資訊,以做出更準確的審核決策。

**為何此優先順序**: 增強審核功能,但不阻礙基本審核流程。可在類型系統穩定後實作。

**獨立測試**: 可以透過審核包含動態欄位的地點來測試,驗證管理員是否能看到完整的類型專屬資訊。

**驗收場景**:

1. **假設** 管理員在待審核列表, **當** 點擊某個地點, **則** 詳情頁面顯示類型圖示、名稱,並列出所有動態欄位
2. **假設** 查看動態欄位, **當** 欄位為必填但使用者未填寫, **則** 顯示警告標示「此欄位應為必填,但提交者未填寫」
3. **假設** 管理員發現動態欄位錯誤, **當** 點擊「編輯」, **則** 可直接修改動態欄位值並儲存
4. **假設** 管理員核准地點, **當** 地點發布到地圖, **則** 動態欄位正確顯示在地點詳情面板

---

### 邊界情況

- 當管理員新增欄位後,現有地點該欄位為空值時如何顯示?(不顯示或顯示「未提供」)
- 現有地點遷移到預設「一般地點」類型後,管理員如何手動重新分類?(提供批次編輯工具)
- 如何處理類型刪除時有大量地點使用的情況?(效能與資料遷移)
- 當使用者提交地點途中,管理員修改了該類型的欄位配置會怎樣?(表單失效或繼續使用舊配置)
- 如何防止管理員建立過多欄位導致表單過長?(限制每類型最多 20 個欄位)
- 當欄位類型為「下拉選單」且管理員刪除某個選項,但現有地點使用該選項時會怎樣?(保留顯示,標註已停用)
- 如何處理動態欄位的查詢與搜尋?(Firestore map 欄位無法索引)
- 當圖示庫不足時,管理員如何自訂圖示?(未來擴展:上傳 SVG 圖示)
- 如何處理類型名稱重複的情況?(系統驗證唯一性)
- 當地圖上有 1000+ 個不同類型的標記時,聚合演算法如何最佳化?(使用 MarkerClusterer 函式庫)

## 需求 *(必填)*

### 功能需求

#### 類型管理

- **FR-001**: 系統必須限制只有擁有 `isSuperAdmin: true` Custom Claim 的使用者可以管理地點類型
- **FR-002**: 系統必須在超級管理後台提供「類型管理」頁面,顯示所有地點類型列表
- **FR-003**: 類型列表必須顯示:圖示預覽、類型名稱、描述、欄位數量、建立時間、啟用狀態、使用次數(有多少地點使用此類型)
- **FR-004**: 超級管理員必須能夠新增類型,要求輸入:類型名稱(3-50 字元)、描述(選填,最多 200 字元)、圖示、顏色
- **FR-005**: 系統必須提供圖示選擇器,包含至少 50 個預建 emoji 圖示,依分類(場地、綠生活、環保、活動)分組
- **FR-006**: 系統必須提供顏色選擇器,包含 6 種預設顏色與自訂顏色輸入(HEX 格式)
- **FR-007**: 系統必須即時預覽類型的地圖標記外觀(圖示 + 顏色)
- **FR-008**: 系統必須支援欄位配置器,允許新增、編輯、刪除、排序欄位
- **FR-009**: 系統必須支援至少 12 種欄位類型:text(單行文字)、textarea(多行文字)、number(數字)、select(單選下拉)、multiSelect(多選下拉)、radio(單選按鈕)、checkbox(多選核取方塊)、date(日期)、time(時間)、datetime(日期時間)、boolean(是/否開關)、url(網址)
- **FR-010**: 欄位配置必須包含:fieldId(唯一識別,系統自動根據 label 生成如 `capacity`,但允許管理員編輯)、label(顯示標籤)、type(欄位類型)、required(是否必填)、order(排序順序)、placeholder(提示文字)、validation(驗證規則,如 min/max)、displayInList(是否在列表顯示)、displayInDetail(是否在詳情顯示)
- **FR-011**: 當欄位類型為 select 或 multiSelect 時,必須額外配置 options 陣列(每個選項包含 value 與 label)
- **FR-012**: 系統必須支援欄位拖曳排序或上下移動按鈕
- **FR-013**: 系統必須驗證類型名稱唯一性(不允許重複)
- **FR-014**: 系統必須限制每個類型最多 20 個動態欄位(避免表單過長)
- **FR-015**: 系統必須將類型配置儲存到 Firestore `location_types/{typeId}` 集合
- **FR-016**: 超級管理員必須能夠編輯現有類型的配置(名稱、描述、圖示、顏色、欄位)
- **FR-017**: 系統必須在編輯類型時警告「變更將影響 X 個現有地點」
- **FR-018**: 超級管理員必須能夠刪除類型,若類型被使用則要求選擇:轉移到其他類型、僅停用
- **FR-019**: 系統必須在刪除類型時,從所有地點的 `typeId` 更新(若選擇轉移)或保留(若選擇停用)
- **FR-020**: 系統必須記錄所有類型管理操作到 `admin_logs` 集合
- **FR-021**: 系統必須在首次部署時建立預設「一般地點」類型(General Location),包含基本圖示與顏色配置
- **FR-022**: 系統必須透過資料遷移腳本將所有現有地點(無 typeId 欄位)自動指派到預設類型,確保向後相容性

#### 地點提交流程

- **FR-023**: 系統必須在地點提交流程的第一步顯示「選擇地點類型」頁面
- **FR-024**: 類型選擇頁面必須顯示所有 `isActive: true` 的類型,包含圖示、名稱、描述
- **FR-025**: 系統必須在使用者選擇類型後,動態生成該類型的提交表單
- **FR-026**: 提交表單必須包含共同欄位(name、address、description、photos)與類型專屬的動態欄位
- **FR-027**: 系統必須根據欄位配置的 `type` 屬性渲染對應的表單元件(例如:number → 數字輸入框,multiSelect → 多選下拉選單)
- **FR-028**: 系統必須根據欄位配置的 `required` 屬性執行必填驗證
- **FR-029**: 系統必須根據欄位配置的 `validation` 屬性執行進階驗證(例如:min/max、正規表達式)
- **FR-030**: 系統必須即時顯示驗證錯誤(無需提交後才顯示)
- **FR-031**: 系統必須將使用者輸入的動態欄位值儲存到 Firestore `locations` 集合的 `dynamicFields` map 欄位
- **FR-032**: 系統必須將選擇的類型 ID 儲存到 `locations` 集合的 `typeId` 欄位
- **FR-033**: 系統必須在地點儲存時同時記錄共同欄位與動態欄位

#### 地圖視覺化

- **FR-034**: 系統必須在地圖載入時查詢所有地點的 `typeId`,並從 `location_types` 取得對應的圖示與顏色配置
- **FR-035**: 系統必須使用 Google Maps Advanced Marker 或自訂 HTML Marker 渲染類型專屬的標記(圖示 + 顏色)
- **FR-036**: 系統必須在標記上顯示類型圖示(emoji 或 SVG)
- **FR-037**: 系統必須在標記上選擇性顯示動態欄位數值(例如:容納人數,若該欄位設定 `displayInList: true`)
- **FR-038**: 系統必須在地圖頂部顯示類型篩選按鈕列,每個按鈕顯示類型圖示與名稱
- **FR-039**: 使用者必須能夠點擊類型按鈕來篩選地圖上的標記,僅顯示該類型
- **FR-040**: 系統必須支援類型篩選與標籤篩選的組合使用
- **FR-041**: 系統必須在地圖縮小時使用 MarkerClusterer 聚合相近標記
- **FR-042**: 聚合標記必須顯示該區域的類型分布(例如:🏢×3 🌿×5,表示 3 個團集會與 5 個綠生活)
- **FR-043**: 系統必須在地點詳情面板顯示類型圖示與名稱
- **FR-044**: 系統必須在詳情面板依據欄位配置的 `displayInDetail: true` 屬性顯示動態欄位
- **FR-045**: 系統必須根據欄位類型正確格式化顯示值(例如:multiSelect → 逗號分隔,boolean → ✅ 或不顯示,date → 格式化日期)

#### 管理員審核

- **FR-046**: 管理員必須能夠在待審核列表查看地點的類型資訊(圖示、名稱)
- **FR-047**: 管理員必須能夠在地點詳情頁面查看所有動態欄位值
- **FR-048**: 系統必須標註必填但未填寫的動態欄位(警告標示)
- **FR-049**: 管理員必須能夠編輯地點的動態欄位值(例如:修正錯誤資料)
- **FR-050**: 系統必須在管理員編輯動態欄位時執行相同的驗證規則

### 關鍵實體

- **Location Type (地點類型)**: Firestore `/location_types/{typeId}`,包含:
  - `id`: 類型 ID(自動生成)
  - `name`: 類型名稱(顯示用)
  - `description`: 類型描述
  - `icon`: 圖示代碼(emoji 或 icon ID)
  - `color`: 地圖標記顏色(HEX 格式)
  - `order`: 排序順序(控制篩選按鈕順序)
  - `isActive`: 是否啟用(停用後不顯示在類型選擇頁面)
  - `fieldSchema`: 欄位配置陣列,每個元素包含:
    - `fieldId`: 欄位唯一識別
    - `label`: 欄位顯示標籤
    - `type`: 欄位類型(text/number/select 等)
    - `required`: 是否必填
    - `order`: 顯示順序
    - `placeholder`: 提示文字
    - `validation`: 驗證規則物件(min/max/pattern 等)
    - `options`: 選項陣列(僅 select/multiSelect 類型)
    - `displayInList`: 是否在地圖標記顯示
    - `displayInDetail`: 是否在詳情面板顯示
  - `commonFields`: 保留共同欄位配置(name/address/description/photos/tags 是否啟用)
  - `createdAt`: 建立時間
  - `createdBy`: 建立者 User ID
  - `updatedAt`: 最後更新時間
  - `updatedBy`: 更新者 User ID

- **Location (修改)**: Firestore `/locations/{locationId}`,新增欄位:
  - `typeId`: 地點類型 ID(必填,參照 location_types)
  - `dynamicFields`: 動態欄位值的 map 物件,鍵為 fieldId,值為使用者輸入的值

- **Icon Library (圖示庫)**: 前端配置檔案,包含:
  - `id`: 圖示 ID
  - `name`: 圖示名稱
  - `emoji`: Emoji 字元
  - `category`: 分類(場地/綠生活/環保/活動)
  - `tags`: 搜尋標籤(選用)

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 超級管理員從開始建立類型到儲存成功,整個過程在 3 分鐘內完成(含配置 5 個欄位)
- **SC-002**: 類型配置儲存到 Firestore 在 2 秒內完成
- **SC-003**: 使用者從選擇類型到看到動態表單,載入時間小於 1 秒
- **SC-004**: 動態表單驗證錯誤即時顯示,回應時間小於 500 毫秒
- **SC-005**: 地圖標記依類型正確顯示圖示與顏色,100% 準確率
- **SC-006**: 類型篩選操作在 500 毫秒內完成標記更新
- **SC-007**: 地圖支援至少 1000 個不同類型的地點標記,效能不降低(保持 60 FPS)
- **SC-008**: 聚合標記在地圖縮放時即時更新,延遲小於 300 毫秒
- **SC-009**: 地點詳情面板載入動態欄位時間小於 1 秒
- **SC-010**: 95% 的使用者能在首次嘗試時成功選擇類型並提交地點(透過使用者測試驗證)
- **SC-011**: 超級管理員能在 10 分鐘內完成「建立新類型 → 使用者提交地點 → 地圖顯示」的完整流程測試
- **SC-012**: 系統支援至少 20 種不同類型且效能不受影響

## 假設與限制

### 假設

- 超級管理員理解動態欄位系統的運作方式
- 預建圖示庫包含的 50+ emoji 足以覆蓋大多數使用情境
- 使用者願意填寫額外的類型專屬欄位
- 12 種欄位類型足以滿足各種資料收集需求
- 管理員會在建立類型前規劃好欄位結構(避免頻繁修改)

### 技術限制

- Firestore map 欄位(`dynamicFields`)無法建立索引,無法直接查詢或排序動態欄位值
- 動態欄位僅能透過類型 ID 或標籤篩選,無法直接搜尋欄位內容(例如:「搜尋容納 50 人以上的場地」)
- Google Maps Marker 效能限制,建議使用 MarkerClusterer 處理大量標記
- 前端需要下載所有 `location_types` 配置才能渲染表單與地圖標記
- 欄位配置變更不會自動遷移現有地點資料(保持資料完整性)

### 業務限制

- 僅超級管理員可以管理類型(管理員無此權限)
- 類型刪除需要謹慎處理,避免資料遺失
- 不支援欄位類型的變更(例如:text → number),僅能刪除後重建
- 動態欄位的驗證規則在前端執行,需要額外的後端驗證(Cloud Functions)
- 圖示庫僅支援 emoji 與預定義圖示,不支援使用者上傳自訂圖示(未來擴展)

## 相依性

### 前置條件

- 超級管理員系統已完成(Epic 6)
- 地點提交功能已完成(Epic 3)
- 地圖瀏覽功能已完成(Epic 1)
- 管理員審核系統已完成(Epic 5)
- Firebase Firestore `location_types` 集合已建立
- Firestore 安全規則已配置類型管理權限(僅超級管理員可寫入)
- Google Maps JavaScript API 已整合
- React 動態表單生成器函式庫已選定(例如:React Hook Form + yup/zod 驗證)
- 資料遷移腳本已準備,用於將現有地點指派到預設類型(首次部署時執行)

### 外部相依

- Firebase Firestore (必要)
- Google Maps JavaScript API (必要)
- Google Maps MarkerClusterer (必要,處理標記聚合)
- React Hook Form 或類似動態表單函式庫(建議)
- Yup 或 Zod 驗證函式庫(建議)
- Emoji 圖示資源(可使用系統內建或第三方函式庫如 emoji-mart)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- 自訂圖示上傳(使用者上傳 SVG 或 PNG 圖示)
- 條件式欄位顯示(例如:當「提供停車位」為 true 時,才顯示「停車位數量」欄位)
- 欄位預設值與自動計算(例如:根據地址自動填入縣市)
- 動態欄位的進階查詢與搜尋(需要資料結構重構或使用 Algolia)
- 欄位群組與分頁(當欄位過多時,分成多個群組或分頁顯示)
- 欄位權限控制(某些欄位僅管理員可見)
- 類型範本系統(預建常見類型範本,如餐廳、活動場地等)
- 欄位版本控制與資料遷移工具
- 批次匯入地點資料(支援 CSV 匯入動態欄位)
- AI 輔助欄位建議(根據類型名稱自動建議適合的欄位)
- 多語系支援(欄位標籤與選項支援多語言)
- 欄位值統計與分析(例如:容納人數的平均值、最大值)
- 地圖熱力圖(依動態欄位數值顯示熱力圖,如容納人數分布)
