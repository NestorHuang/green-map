# 功能規格: 地點資訊錯誤回報

**功能分支**: `004-error-reporting`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "讓已登入使用者回報地點資訊錯誤,幫助維護資料正確性與即時性"

## Clarifications

### Session 2025-12-02

- Q: 重複回報防護範圍 (Duplicate Report Protection Scope) → A: 檢測相同使用者+相同地點+未處理狀態 - 只防止同一使用者對同一地點的重複未處理回報。此方案平衡資料品質與使用者體驗,允許不同使用者回報相同問題有助於驗證,若先前回報已處理但問題再次發生,使用者可再次回報
- Q: 惡意回報防護機制 (Malicious Report Protection) → A: 時間冷卻機制 - 每次回報後需等待15分鐘才能提交下一個回報。此方案在不限制正常使用者的前提下,有效減緩惡意大量提交的可能性,且實作簡單無需複雜的配額追蹤
- Q: 冷卻計時器儲存位置 (Cooldown Timer Storage) → A: 混合模式 - Firestore 為權威來源,localStorage 作為快取提升 UX 回應速度。在 users/{uid} 儲存 lastReportedAt 確保跨裝置一致且無法繞過,同時使用 localStorage 快取避免每次檢查都需讀取 Firestore,提升使用者體驗回應速度

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 回報地點資訊有誤 (優先順序: P1)

已登入使用者在查看地點詳情時發現資訊錯誤(例如:已歇業、地址錯誤),希望回報以幫助更新資料。

**為何此優先順序**: 憲章的 Data Integrity & Trust 原則要求資料正確性。此功能是維護資料品質的關鍵,與核心瀏覽功能同等重要。

**獨立測試**: 可以透過點擊「回報錯誤」按鈕並提交回報來完全測試,驗證資料是否正確儲存到 Firestore。

**驗收場景**:

1. **假設** 已登入使用者查看地點詳情, **當** 點擊「回報此地點資訊有誤」按鈕, **則** 顯示錯誤回報表單
2. **假設** 使用者填寫回報表單, **當** 選擇錯誤類型, **則** 提供預設選項:已歇業、地址錯誤、電話錯誤、描述不符、照片不符、其他
3. **假設** 使用者選擇錯誤類型, **當** 選擇「其他」, **則** 要求輸入詳細說明(必填)
4. **假設** 使用者提交回報, **當** 資料送出, **則** 儲存到 Firestore `error_reports` 集合,狀態為 `pending`
5. **假設** 回報成功, **當** 顯示確認訊息, **則** 告知「感謝回報,管理員將在 3 個工作天內處理」
6. **假設** 使用者對同一地點重複回報, **當** 檢測到重複, **則** 顯示警告「您已回報此地點,請勿重複提交」並阻止提交
7. **假設** 使用者剛提交回報, **當** 在15分鐘內嘗試提交新回報, **則** 顯示錯誤訊息「請稍後再試,您可以在 X 分鐘後提交下一個回報」並禁用提交按鈕

---

### 使用者故事 2 - 查看我的回報記錄 (優先順序: P2)

已登入使用者希望查看自己的錯誤回報記錄與處理狀態,以了解回報是否被採納。

**為何此優先順序**: 提供良好的回饋機制,增加使用者參與感,但不阻礙核心回報功能。

**驗收場景**:

1. **假設** 已登入使用者, **當** 前往個人檔案頁面, **則** 看到「我的回報」標籤
2. **假設** 使用者點擊標籤, **當** 載入回報列表, **則** 顯示所有回報記錄(包含待處理、已處理、已忽略)
3. **假設** 列表中有多個回報, **當** 查看每個項目, **則** 顯示地點名稱、錯誤類型、回報時間、處理狀態
4. **假設** 管理員處理回報後, **當** 狀態更新, **則** 使用者看到處理結果與管理員備註

---

### 使用者故事 3 - 接收回報處理通知 (優先順序: P3)

已登入使用者希望在錯誤回報被處理後收到通知,以了解自己的貢獻被採納。

**為何此優先順序**: 增強使用者參與感與滿意度,但不是 MVP 必需功能。可在基本回報功能穩定後實作。

**驗收場景**:

1. **假設** 管理員處理使用者的回報, **當** 狀態更新為 `resolved` 或 `ignored`, **則** 使用者收到通知
2. **假設** 回報被採納, **當** 使用者查看通知, **則** 顯示「感謝您的回報,地點資訊已更新」
3. **假設** 回報被忽略, **當** 使用者查看通知, **則** 顯示忽略原因(例如:「經查證資訊正確」)

---

### 邊界情況

- 當使用者對已被回報多次的地點再次回報時會怎樣?
- 如何處理惡意回報(例如:故意提交錯誤資訊)?
- 當地點在使用者回報後被刪除時會怎樣?
- 冷卻期間使用者嘗試提交會看到什麼訊息?
- localStorage 快取與 Firestore 權威來源不一致時如何處理?
- 使用者跨裝置登入時冷卻機制如何運作?
- Firestore 讀取失敗時如何回退到 localStorage?
- 當使用者回報時網路中斷會怎樣?
- 如何處理極長的錯誤說明(超過 500 字)?

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須限制只有已登入使用者可以回報地點錯誤
- **FR-002**: 系統必須在地點詳情頁面顯示「回報此地點資訊有誤」按鈕(僅登入使用者可見)
- **FR-003**: 系統必須提供錯誤回報表單,包含欄位:錯誤類型、詳細說明(選填,「其他」類型為必填)
- **FR-004**: 系統必須提供預設錯誤類型選項:已歇業、地址錯誤、電話錯誤、描述不符、照片不符、其他
- **FR-005**: 系統必須限制詳細說明長度為 10-500 字元
- **FR-006**: 系統必須檢測使用者是否已對同一地點提交過未處理的回報,若是則阻止重複提交
- **FR-007**: 系統必須在 Firestore `error_reports` 集合建立新文件,初始狀態為 `pending`
- **FR-008**: 系統必須記錄回報者資訊:使用者 ID、顯示名稱、回報時間
- **FR-009**: 系統必須記錄被回報的地點資訊:地點 ID、地點名稱
- **FR-010**: 系統必須在使用者個人檔案頁面顯示回報記錄列表
- **FR-011**: 系統必須允許使用者查看自己的回報記錄,包含狀態:待處理、已處理、已忽略
- **FR-012**: 系統必須在管理員處理回報後更新狀態與處理時間
- **FR-013**: 系統必須限制使用者只能查看自己提交的回報(透過 Firestore 安全規則)
- **FR-014**: 系統必須在回報列表中顯示處理狀態的視覺標示(例如:不同顏色或圖示)
- **FR-015**: 系統必須在回報成功後顯示確認訊息,說明預計處理時間(3 個工作天)
- **FR-016**: 系統必須在使用者成功提交回報後,更新 Firestore `users/{uid}` 文件的 `lastReportedAt` 時間戳記,並同步更新 localStorage 快取,在15分鐘內阻止該使用者提交新的錯誤回報
- **FR-017**: 系統必須在冷卻期間顯示剩餘等待時間(精確到分鐘),並禁用回報表單的提交按鈕;檢查冷卻狀態時優先讀取 localStorage 快取,若快取不存在或可疑則查詢 Firestore 作為權威驗證
- **FR-018**: 系統必須在成功提交回報後,同時更新 Firestore 與 localStorage 的冷卻時間戳記,確保兩者同步

### 關鍵實體 *(包含因為功能涉及資料)*

- **Error Report (錯誤回報)**: Firestore `/error_reports/{reportId}`,包含:
  - `locationId`: 被回報的地點 ID
  - `locationName`: 被回報的地點名稱(冗餘儲存,避免地點刪除後資料遺失)
  - `errorType`: 錯誤類型(`closed` | `address_error` | `phone_error` | `description_mismatch` | `photo_mismatch` | `other`)
  - `description`: 詳細說明(選填,「其他」類型必填)
  - `reportedBy`: 回報者 User ID
  - `reporterInfo`: 嵌入物件(顯示名稱)
  - `status`: `pending` | `resolved` | `ignored`
  - `createdAt`: 回報時間
  - `resolvedAt`: 處理時間(若已處理)
  - `resolvedBy`: 處理者 User ID(若已處理)
  - `adminNote`: 管理員備註(處理結果說明)

- **User (使用者)**: Firestore `/users/{uid}`,包含:
  - `lastReportedAt`: 最後一次提交錯誤回報的時間戳記(用於15分鐘冷卻機制)
  - (其他使用者欄位由 Epic 002 定義)

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 使用者從點擊「回報錯誤」到提交成功,整個過程在 30 秒內完成
- **SC-002**: 回報資料儲存到 Firestore 在 2 秒內完成
- **SC-003**: 重複回報檢測在 1 秒內完成
- **SC-004**: 回報列表載入時間小於 2 秒(最多 50 筆記錄)
- **SC-005**: 95% 的使用者能在首次嘗試時成功提交回報(透過使用者測試驗證)
- **SC-006**: 管理員在 3 個工作天內處理 90% 的回報
- **SC-007**: 回報表單驗證錯誤即時顯示(無需提交後才顯示)
- **SC-008**: 回報成功率達到 99% 以上(排除網路中斷等外部因素)

## 假設與限制

### 假設

- 使用者理解回報需要時間處理
- 使用者提供的錯誤描述是真實且有幫助的
- 管理員有足夠人力在 3 個工作天內處理回報
- 使用者不會惡意濫用回報功能

### 技術限制

- Firestore 免費層寫入次數限制
- 無自動化驗證機制(需人工審核)
- 重複回報檢測僅限於未處理的回報

### 業務限制

- 所有回報必須經過管理員人工審核
- 不支援使用者撤銷已提交的回報
- 回報處理時間目標為 3 個工作天,但不保證
- 不支援匿名回報(必須登入)

## 相依性

### 前置條件

- 使用者認證系統已完成(Epic 2)
- 地圖瀏覽功能已完成(Epic 1)
- Firebase Firestore `error_reports` 集合已建立
- Firestore 安全規則已配置回報提交與查詢權限
- 管理員審核系統已規劃(Epic 5)

### 外部相依

- Firebase Firestore (必要)
- Firebase Auth (使用者身份驗證)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- 回報優先級標記(緊急、一般)
- 社群投票機制(多人回報相同錯誤時自動提高優先級)
- AI 輔助偵測常見錯誤模式
- 批次處理多個回報
- 回報者獎勵機制(積分系統)
- 回報統計儀表板(給管理員)
- Email 通知管理員有新回報
- 使用者可上傳證明照片(例如:證明已歇業的照片)
- 自動關閉過期回報(例如:6 個月未處理)
- 回報分類自動化(基於關鍵字)
