# 功能規格: 管理員審核與管理

**功能分支**: `005-admin-management`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "讓管理員審核地點提交、處理錯誤回報、驗證荒野夥伴身份"

## Clarifications

### Session 2025-12-02

- Q: 並行審核衝突處理 (Concurrent Review Conflict Handling) → A: 樂觀鎖定(Optimistic Locking) - 允許多人同時查看,提交時檢查版本號,若已被修改則提示衝突並要求重新載入。此方案平衡用戶體驗與資料一致性,管理員同時審核同一地點的機率較低,樂觀鎖定可避免不必要的鎖定開銷,Firestore 原生支援此模式,實作簡單且高效
- Q: 荒野夥伴驗證流程 (Wilderness Partner Verification Process) → A: 信任制無驗證 - 直接核准申請,依賴使用者誠實申報。此方案與 Epic 002 已澄清的「荒野編號僅輸入不驗證」保持一致,管理員僅需檢查申請資料格式完整性(所屬分會、自然名),無需查詢外部資料庫。降低管理員工作量與系統複雜度,符合平台信任導向的設計哲學
- Q: 誤操作防護機制 (Accidental Operation Protection) → A: 確認對話框 - 點擊核准/拒絕後彈出確認對話框,顯示操作摘要並要求二次確認。此方案平衡安全性與效率,可有效防止誤操作(特別是「核准」與「拒絕」的混淆),顯示操作摘要(地點名稱、操作類型)讓管理員有最後檢查機會,比撤銷功能更簡單且即時

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 審核待核准地點 (優先順序: P1)

管理員希望審核使用者提交的地點,確保資訊正確後核准或拒絕。

**為何此優先順序**: 憲章的 Data Integrity & Trust 原則要求人工審核。這是平台資料品質的關鍵守門人。

**獨立測試**: 可以透過查看待審核列表並執行核准/拒絕操作來完全測試。

**驗收場景**:

1. **假設** 管理員登入系統, **當** 前往管理後台, **則** 看到「待審核地點」列表,按提交時間倒序排列
2. **假設** 列表中有多個待審核地點, **當** 點擊其中一個, **則** 顯示完整地點資訊:名稱、地址、描述、照片、標籤、提交者
3. **假設** 管理員確認資訊正確, **當** 點擊「核准」按鈕, **則** 更新地點狀態為 `approved`,記錄審核時間與審核者,並通知提交者
4. **假設** 管理員發現資訊錯誤, **當** 點擊「拒絕」按鈕, **則** 要求輸入拒絕原因(必填)
5. **假設** 管理員輸入拒絕原因, **當** 確認拒絕, **則** 更新地點狀態為 `rejected`,記錄原因、審核時間與審核者,並通知提交者
6. **假設** 提交者為荒野夥伴, **當** 查看地點資訊, **則** 顯示荒野夥伴徽章與「團名-自然名」資訊
7. **假設** 管理員審核完成, **當** 返回列表, **則** 該地點從待審核列表中移除
8. **假設** 管理員正在審核地點,但另一管理員已先完成審核, **當** 提交審核決定, **則** 系統偵測版本號不一致,顯示錯誤訊息「此地點已被其他管理員審核,請重新載入」並阻止提交
9. **假設** 管理員點擊「核准」或「拒絕」按鈕, **當** 觸發操作, **則** 彈出確認對話框顯示操作摘要(操作類型、地點名稱、提交者),並提供「確認」與「取消」按鈕;只有點擊「確認」後才實際執行操作

---

### 使用者故事 2 - 處理錯誤回報 (優先順序: P1)

管理員希望處理使用者回報的地點錯誤,更新資料或標記為已處理。

**為何此優先順序**: 維護資料正確性與即時性的關鍵流程,與地點審核同等重要。

**獨立測試**: 可以透過查看回報列表並執行處理操作來完全測試。

**驗收場景**:

1. **假設** 管理員登入系統, **當** 前往管理後台, **則** 看到「待處理回報」列表,按回報時間倒序排列
2. **假設** 列表中有多個回報, **當** 點擊其中一個, **則** 顯示回報詳情:地點資訊、錯誤類型、詳細說明、回報者
3. **假設** 管理員確認回報正確, **當** 選擇「編輯地點資訊」, **則** 進入地點編輯頁面,可直接修改錯誤資訊
4. **假設** 管理員完成修改, **當** 儲存變更, **則** 更新地點資訊並自動將回報狀態設為 `resolved`,記錄處理時間與處理者
5. **假設** 管理員認為回報不正確, **當** 點擊「忽略回報」, **則** 要求輸入備註說明原因
6. **假設** 管理員輸入備註, **當** 確認忽略, **則** 更新回報狀態為 `ignored`,記錄備註、處理時間與處理者,並通知回報者
7. **假設** 回報類型為「已歇業」, **當** 管理員確認, **則** 可選擇「刪除地點」或「標記為已歇業」(未來功能)
8. **假設** 管理員點擊「忽略回報」或「編輯地點資訊」按鈕, **當** 觸發操作, **則** 彈出確認對話框顯示操作摘要(操作類型、地點名稱、回報類型),並提供「確認」與「取消」按鈕

---

### 使用者故事 3 - 驗證荒野夥伴身份 (優先順序: P1)

管理員希望審核荒野夥伴驗證申請,確認荒野編號後核准或拒絕。

**為何此優先順序**: 憲章的 Community-First Development 原則要求支持荒野夥伴,身份驗證是實現此原則的關鍵。

**獨立測試**: 可以透過查看待驗證列表並執行核准/拒絕操作來完全測試。

**驗收場景**:

1. **假設** 管理員登入系統, **當** 前往管理後台, **則** 看到「待驗證荒野夥伴」列表,按申請時間倒序排列
2. **假設** 列表中有多個申請, **當** 點擊其中一個, **則** 顯示申請詳情:荒野編號、所屬分會、自然名、申請者 Email
3. **假設** 管理員確認申請資料格式完整(所屬分會與自然名皆已填寫), **當** 點擊「核准」按鈕, **則** 更新使用者 Custom Claims(`isWildernessPartner: true`),記錄驗證時間與驗證者,並通知申請者
4. **假設** 管理員發現申請資料不完整或格式不符, **當** 點擊「拒絕」按鈕, **則** 要求輸入拒絕原因(必填)
5. **假設** 管理員輸入拒絕原因, **當** 確認拒絕, **則** 更新申請狀態為 `rejected`,記錄原因、驗證時間與驗證者,並通知申請者
6. **假設** 申請被核准, **當** 使用者下次登入, **則** 自動取得荒野夥伴權限,個人檔案顯示徽章
7. **假設** 管理員點擊「核准」或「拒絕」按鈕, **當** 觸發操作, **則** 彈出確認對話框顯示操作摘要(操作類型、申請者 Email、所屬分會、自然名),並提供「確認」與「取消」按鈕

---

### 使用者故事 4 - 查看審核統計 (優先順序: P2)

管理員希望查看審核統計資料,以了解平台活躍度與審核效率。

**為何此優先順序**: 提供管理洞察,但不阻礙核心審核功能。可在基本審核功能穩定後實作。

**驗收場景**:

1. **假設** 管理員登入系統, **當** 前往管理後台首頁, **則** 顯示統計儀表板
2. **假設** 查看儀表板, **當** 載入數據, **則** 顯示:待審核地點數、待處理回報數、待驗證夥伴數、本月核准地點數、平均審核時間
3. **假設** 管理員點擊統計數字, **當** 展開詳情, **則** 顯示該類別的詳細列表
4. **假設** 有緊急待處理項目(例如:超過 3 天未處理), **當** 查看儀表板, **則** 以紅色標示提醒

---

### 邊界情況

- 當管理員在審核過程中網路中斷會怎樣?
- 如何處理同一地點被多個管理員同時審核的情況?
- 樂觀鎖定衝突發生時,管理員已填寫的拒絕原因是否保留?
- 版本號檢查失敗時如何清楚告知管理員發生了什麼?
- 當地點在審核過程中被提交者修改會怎樣?
- 確認對話框是否支援鍵盤快捷鍵(Enter 確認、Esc 取消)?
- 管理員在確認對話框中點擊「取消」後,已填寫的拒絕原因是否保留?
- 確認對話框顯示時,背景內容是否鎖定防止誤點?
- 當回報的地點已被刪除時會怎樣?
- 如何處理申請資料格式不符(例如:自然名包含數字或特殊字元)?
- 當管理員帳號被撤銷權限時,已審核的記錄如何處理?

## 需求 *(必填)*

### 功能需求

#### 地點審核

- **FR-001**: 系統必須限制只有擁有 `isAdmin: true` Custom Claim 的使用者可以存取管理後台
- **FR-002**: 系統必須在管理後台顯示所有狀態為 `pending` 的地點列表
- **FR-003**: 管理員必須能夠查看地點的完整資訊:名稱、地址、座標、描述、照片、標籤、提交者資訊
- **FR-004**: 管理員必須能夠核准地點,更新狀態為 `approved`,記錄 `reviewedAt` 與 `reviewedBy`
- **FR-005**: 管理員必須能夠拒絕地點,要求輸入拒絕原因,更新狀態為 `rejected`
- **FR-006**: 系統必須限制拒絕原因長度為 10-200 字元
- **FR-007**: 系統必須在地點狀態更新後通知提交者(透過內部通知系統)
- **FR-025**: 系統必須在地點文件中維護 `version` 欄位(每次更新時自動遞增),用於樂觀鎖定衝突檢測
- **FR-026**: 系統必須在管理員提交審核決定時,檢查地點的 `version` 欄位是否與載入時一致;若不一致,則拒絕提交並顯示錯誤訊息「此地點已被其他管理員審核,請重新載入最新資訊」
- **FR-027**: 系統必須在管理員點擊核准/拒絕/忽略等關鍵操作按鈕後,彈出確認對話框顯示操作摘要(包含操作類型、目標名稱、相關資訊)
- **FR-028**: 確認對話框必須提供「確認」與「取消」兩個按鈕,並支援鍵盤快捷鍵(Enter 確認、Esc 取消)
- **FR-029**: 系統必須在確認對話框顯示時鎖定背景內容,防止誤點擊;點擊「取消」後保留管理員已填寫的輸入內容(如拒絕原因)

#### 錯誤回報處理

- **FR-008**: 系統必須在管理後台顯示所有狀態為 `pending` 的錯誤回報列表
- **FR-009**: 管理員必須能夠查看回報詳情:地點資訊、錯誤類型、詳細說明、回報者資訊
- **FR-010**: 管理員必須能夠直接編輯被回報的地點資訊
- **FR-011**: 系統必須在管理員儲存地點修改後,自動將相關回報狀態設為 `resolved`
- **FR-012**: 管理員必須能夠忽略回報,要求輸入備註說明原因,更新狀態為 `ignored`
- **FR-013**: 系統必須限制忽略備註長度為 10-200 字元
- **FR-014**: 系統必須在回報狀態更新後通知回報者

#### 荒野夥伴驗證

- **FR-015**: 系統必須在管理後台顯示所有驗證狀態為 `pending` 的荒野夥伴申請列表
- **FR-016**: 管理員必須能夠查看申請詳情:荒野編號、所屬分會、自然名、申請者 Email;系統應顯示資料完整性檢查結果(所有必填欄位皆已填寫)
- **FR-017**: 管理員必須能夠核准申請,透過 Cloud Function 更新使用者 Custom Claims(`isWildernessPartner: true`)
- **FR-018**: 管理員必須能夠拒絕申請,要求輸入拒絕原因,更新狀態為 `rejected`
- **FR-019**: 系統必須限制拒絕原因長度為 10-200 字元
- **FR-020**: 系統必須在申請狀態更新後通知申請者

#### 統計與監控

- **FR-021**: 系統必須在管理後台首頁顯示統計儀表板
- **FR-022**: 儀表板必須顯示:待審核地點數、待處理回報數、待驗證夥伴數、本月核准地點數
- **FR-023**: 系統必須計算並顯示平均審核時間(從提交到審核完成)
- **FR-024**: 系統必須標示超過 3 天未處理的項目(紅色警示)

### 關鍵實體 *(已在前面的 Epic 定義,此處列出管理員操作相關欄位)*

- **Location**: 新增審核相關欄位:
  - `version`: 版本號(整數),每次更新時自動遞增,用於樂觀鎖定衝突檢測
  - `reviewedAt`: 審核時間
  - `reviewedBy`: 審核者 User ID
  - `rejectionReason`: 拒絕原因(若被拒絕)

- **Error Report**: 新增處理相關欄位:
  - `resolvedAt`: 處理時間
  - `resolvedBy`: 處理者 User ID
  - `adminNote`: 管理員備註

- **User (Wilderness Verification)**: 新增驗證相關欄位:
  - `verifiedAt`: 驗證時間
  - `verifiedBy`: 驗證管理員 ID
  - `rejectionReason`: 拒絕原因(若被拒絕)

- **Admin Action Log (管理員操作記錄)**: 新建 Firestore `/admin_logs/{logId}`,包含:
  - `actionType`: 操作類型(`approve_location` | `reject_location` | `resolve_report` | `ignore_report` | `verify_partner` | `reject_partner`)
  - `targetId`: 目標 ID(地點 ID、回報 ID、使用者 ID)
  - `adminId`: 管理員 User ID
  - `details`: 操作詳情(例如:拒絕原因)
  - `timestamp`: 操作時間

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 管理員審核單一地點的時間平均在 2 分鐘內完成(含資訊確認)
- **SC-002**: 管理員處理單一錯誤回報的時間平均在 3 分鐘內完成(含資訊確認與編輯)
- **SC-003**: 管理員驗證單一荒野夥伴的時間平均在 1 分鐘內完成(含編號確認)
- **SC-004**: 管理後台載入時間小於 3 秒
- **SC-005**: 待審核列表載入時間小於 2 秒(最多 100 筆記錄)
- **SC-006**: 統計儀表板數據即時更新,延遲小於 5 秒
- **SC-007**: 核准/拒絕操作的資料庫更新在 2 秒內完成
- **SC-008**: 90% 的地點在提交後 3 個工作天內完成審核
- **SC-009**: 90% 的錯誤回報在 3 個工作天內完成處理
- **SC-010**: 管理員操作成功率達到 99.9% 以上

## 假設與限制

### 假設

- 管理員有足夠時間與人力處理審核工作
- 管理員理解平台的審核標準與政策
- 使用者誠實申報荒野夥伴身份,不會惡意冒用(信任制)
- 管理員擁有穩定的網路連線

### 技術限制

- Custom Claims 更新需要透過 Cloud Function(無法從前端直接更新)
- Custom Claims 更新後,使用者需要重新登入才能生效
- Firestore 安全規則限制只有管理員可以修改地點狀態
- 無自動化審核機制(全部人工審核)

### 業務限制

- 管理員帳號由超級管理員手動建立(Epic 6)
- 審核標準由平台政策定義(需另外文件化)
- 不支援批次審核多個地點
- 不支援管理員委派審核權限

## 相依性

### 前置條件

- 使用者認證系統已完成(Epic 2)
- 地點提交功能已完成(Epic 3)
- 錯誤回報功能已完成(Epic 4)
- Firebase Custom Claims 機制已理解與配置
- Cloud Functions 已部署用於 Custom Claims 更新
- Firestore 安全規則已配置管理員存取權限
- 管理員帳號已由超級管理員建立(Epic 6 前置工作)

### 外部相依

- Firebase Firestore (必要)
- Firebase Auth with Custom Claims (必要)
- Firebase Cloud Functions (必要)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- 批次審核功能(一次核准多個地點)
- 審核工作流程分配(自動分配給特定管理員)
- 審核歷史記錄與搜尋
- 管理員績效追蹤(審核數量、品質)
- AI 輔助審核(自動偵測明顯錯誤)
- 審核優先級排序(基於提交者等級、地點重要性)
- 管理員協作功能(標註、討論)
- 審核 SLA 自動提醒(超過時限自動通知)
- 地點編輯版本控制
- 審核決策記錄與稽核
