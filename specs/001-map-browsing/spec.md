# 功能規格: 地圖瀏覽與探索

**功能分支**: `001-map-browsing`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "實作互動式地圖瀏覽功能,讓訪客可以快速找到附近的綠色生活地點"

## Clarifications

### Session 2025-12-02

- Q: GPS 權限被拒絕後,應該如何引導使用者? → A: 提供手動地址輸入功能作為備援方案,讓使用者可以輸入地址來定位地圖中心,同時顯示友善提示訊息說明權限的用途
- Q: 當 GPS 權限被拒絕且使用者未手動輸入地址時,預設位置應該如何選擇? → A: 顯示台灣全島視圖(縮放至可見所有地點),讓使用者自行選擇區域
- Q: 在行動裝置上,當使用者查看地點詳情面板時,應該如何關閉面板返回地圖檢視? → A: 提供向下滑動手勢關閉功能搭配關閉按鈕,提供多種操作方式並符合現代行動 UX 標準

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 快速定位當前位置 (優先順序: P1)

一般訪客打開網站時,希望自動定位到當前位置,以便快速找到附近的綠色生活地點。

**為何此優先順序**: 這是平台的核心價值 - 讓使用者在 30 秒內找到附近的綠色地點。GPS 自動定位是實現此目標的關鍵。

**獨立測試**: 可以透過開啟網站並授予 GPS 權限來完全測試,驗證地圖是否自動移動到使用者當前位置。

**驗收場景**:

1. **假設** 使用者首次造訪網站, **當** 頁面載入完成, **則** 瀏覽器自動請求 GPS 位置權限
2. **假設** 使用者允許 GPS 權限, **當** 取得位置成功, **則** 地圖中心移動到使用者當前位置並縮放至適當層級
3. **假設** 使用者拒絕 GPS 權限, **當** 權限被拒絕, **則** 地圖顯示預設位置(高雄車站)並顯示友善提示訊息
4. **假設** GPS 取得失敗(例如室內或訊號不良), **當** 超時或失敗, **則** 顯示錯誤訊息並回退到預設位置

---

### 使用者故事 2 - 查看地點詳細資訊 (優先順序: P1)

一般訪客點擊地圖上的標記時,希望查看地點的詳細資訊,以了解該地點是否符合需求。

**為何此優先順序**: 這是使用者決定是否造訪該地點的關鍵資訊,與 GPS 定位同等重要,是 MVP 的核心功能。

**獨立測試**: 可以透過點擊任何地圖標記來測試,驗證是否正確顯示地點詳情面板及所有必要資訊。

**驗收場景**:

1. **假設** 地圖上有多個地點標記, **當** 使用者點擊其中一個標記, **則** 底部彈出詳情面板顯示該地點資訊
2. **假設** 詳情面板已開啟, **當** 使用者查看內容, **則** 顯示地點名稱、地址、描述、照片輪播、綠活標籤、登錄者資訊
3. **假設** 登錄者為荒野夥伴, **當** 顯示登錄者資訊, **則** 以「團名-自然名」格式顯示(例如:「台南分會-樹蛙」)
4. **假設** 詳情面板已開啟(行動裝置), **當** 使用者向下滑動面板或點擊關閉按鈕, **則** 面板關閉並返回地圖檢視
5. **假設** 詳情面板已開啟(桌面版), **當** 使用者點擊關閉按鈕或面板外部區域, **則** 面板關閉並返回地圖檢視
6. **假設** 使用者已登入, **當** 查看地點詳情, **則** 顯示「回報此地點資訊有誤」按鈕

---

### 使用者故事 3 - 搜尋特定地址 (優先順序: P2)

一般訪客希望搜尋特定地址附近的綠色生活地點,以便規劃行程時找到目的地附近的綠色選項。

**為何此優先順序**: 雖然重要,但不是 MVP 必需功能。使用者可以手動拖曳地圖來探索,此功能可在 P1 功能穩定後再實作。

**獨立測試**: 可以透過在搜尋框輸入地址並選擇來測試,驗證地圖是否正確移動到該位置。

**驗收場景**:

1. **假設** 使用者想找特定地址附近的地點, **當** 在頂部搜尋框輸入文字, **則** 顯示 Google Places 的地址建議列表
2. **假設** 建議列表已顯示, **當** 使用者選擇其中一個地址, **則** 地圖自動移動並放大至該位置
3. **假設** 使用者輸入中文地址, **當** 開始輸入, **則** 正確顯示台灣範圍內的地址建議
4. **假設** 使用者選擇了地址, **當** 地圖移動完成, **則** 搜尋框清空或保留搜尋文字供參考

---

### 使用者故事 4 - 依標籤篩選地點 (優先順序: P2)

一般訪客希望只顯示特定類型的地點(例如:全素餐廳),以快速找到符合特定需求的地點。

**為何此優先順序**: 是重要的使用者體驗增強功能,但不阻礙基本的地點瀏覽。可在基本地圖功能完成後實作。

**獨立測試**: 可以透過點擊不同標籤來測試,驗證地圖是否只顯示符合該標籤的地點。

**驗收場景**:

1. **假設** 地圖上有多個不同類型的地點, **當** 使用者點擊「全素/蔬食」標籤, **則** 地圖僅顯示包含該標籤的地點
2. **假設** 已選擇特定標籤, **當** 查看介面, **則** 該標籤有視覺高亮顯示(例如:不同顏色或邊框)
3. **假設** 已套用篩選, **當** 使用者點擊「全部」按鈕或再次點擊相同標籤, **則** 取消篩選並顯示所有地點
4. **假設** 使用者切換不同標籤, **當** 篩選條件改變, **則** 地點列表即時更新且無需重新載入頁面

---

### 邊界情況

- 當使用者位於 GPS 訊號不良的區域(例如:室內、地下室)時會怎樣?
- 如何處理地圖上沒有任何地點標記的情況?
- 當使用者快速連續點擊多個標記時,詳情面板如何回應?
- 如果選擇的標籤沒有任何地點時該如何顯示?
- 當地點照片載入失敗時如何處理?
- 地圖縮放到極限時(放大或縮小)如何處理?

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須在頁面載入時自動請求使用者的 GPS 位置權限
- **FR-002**: 系統必須在取得 GPS 位置後,將地圖中心移動到使用者當前位置
- **FR-003**: 系統必須在 GPS 失敗或被拒絕時,顯示友善提示訊息並提供手動地址輸入框,允許使用者輸入地址來定位地圖中心;若使用者未輸入地址,則顯示台灣全島視圖(縮放至可見所有已核准的地點標記)
- **FR-004**: 系統必須在地圖上顯示所有已核准狀態(`status: 'approved'`)的綠色生活地點
- **FR-005**: 使用者必須能夠透過點擊地圖標記來查看地點詳細資訊
- **FR-006**: 地點詳情面板必須顯示:名稱、地址、描述、照片、標籤、登錄者資訊
- **FR-007**: 系統必須支援地圖的基本操作:縮放、拖曳、平移
- **FR-008**: 系統必須整合 Google Places Autocomplete API 提供地址搜尋功能
- **FR-009**: 系統必須限制地址搜尋範圍為台灣,搜尋類型為營業場所(establishment)
- **FR-010**: 使用者必須能夠透過點擊標籤來篩選地圖上的地點
- **FR-011**: 系統必須在頂部顯示所有可用的綠活標籤選項
- **FR-012**: 系統必須在行動裝置上支援向下滑動手勢關閉詳情面板,並同時提供關閉按鈕(X)作為替代方案
- **FR-013**: 系統必須在桌面版支援點擊詳情面板外部區域或關閉按鈕來關閉面板
- **FR-014**: 系統必須在登錄者為荒野夥伴時,以「團名-自然名」格式顯示
- **FR-015**: 系統必須僅對已登入使用者顯示「回報此地點資訊有誤」按鈕
- **FR-016**: 系統必須在照片載入失敗時顯示預設佔位圖片

### 關鍵實體 *(包含因為功能涉及資料)*

- **Location (地點)**: 代表一個綠色生活地點,包含名稱、地址、經緯度(GeoPoint)、描述、照片 URL 陣列、標籤 ID 陣列、狀態、提交者資訊、時間戳記
- **Tag (標籤)**: 代表綠活標籤分類,包含標籤 ID、標籤名稱
- **Submitter Info (提交者資訊)**: 嵌入在 Location 中,包含顯示名稱、是否為荒野夥伴、團名、自然名

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 使用者從開啟網站到看到自己當前位置的地圖,整個過程在 5 秒內完成(包含 GPS 取得時間)
- **SC-002**: 地圖在 3 秒內完成初始載入(4G 網路環境)
- **SC-003**: 地點標記點擊後詳情面板在 200 毫秒內彈出
- **SC-004**: 地圖可以同時顯示至少 100 個地點標記且效能不降低(保持 60 FPS)
- **SC-005**: 地址搜尋在使用者輸入後 1 秒內返回建議結果
- **SC-006**: 標籤篩選操作在 500 毫秒內完成地點更新
- **SC-007**: 95% 的使用者能在第一次嘗試時成功使用地圖找到地點(透過使用者測試驗證)
- **SC-008**: GPS 定位成功率達到 90% 以上(在戶外環境)
- **SC-009**: 地圖操作(縮放、拖曳)流暢度達到 60 FPS
- **SC-010**: Lighthouse 效能分數大於 90 分

## 假設與限制

### 假設

- 使用者主要使用行動裝置(手機)造訪平台
- 使用者願意授予 GPS 位置權限
- Firebase Firestore 已包含至少一些已核准的地點資料
- Google Maps API 金鑰已正確配置且有足夠配額
- 使用者的裝置支援現代瀏覽器(Chrome, Firefox, Safari, Edge)

### 技術限制

- Google Maps API 免費配額:每月 $200 美元等值
- Firestore 讀取:免費層每日 50,000 次
- 地圖載入每 1000 次成本 $7 美元
- 不支援 IE11 瀏覽器
- GPS 功能依賴使用者裝置硬體支援

### 業務限制

- 當前範圍限制為台灣南區
- 僅支援繁體中文介面
- 所有使用者(包含未登入訪客)都可瀏覽地圖

## 相依性

### 前置條件

- Firebase 專案已建立且正確配置
- Firestore 資料庫已初始化
- `locations` 集合已存在且有基本資料結構
- `tags` 集合已存在且包含預設標籤
- Google Maps JavaScript API 已啟用
- Google Places API 已啟用
- Google Geocoding API 已啟用
- 環境變數中已設定 Google Maps API 金鑰

### 外部相依

- Google Maps JavaScript API (必要)
- Google Places API (P2 功能需要)
- Firebase Firestore (必要)
- 使用者的網路連線(3G/4G/WiFi)
- 使用者的 GPS 硬體(選用,失敗時回退到預設位置)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- 路線規劃功能(整合 Google Directions API)
- 周邊搜索(搜尋附近 X 公里內的地點)
- 地點聚合(Marker Clustering)處理大量標記
- 即時位置追蹤(使用者移動時地圖自動更新)
- 離線地圖支援
- 自訂地圖樣式(深色模式等)
- 地點收藏功能
- 分享地點到社交媒體
