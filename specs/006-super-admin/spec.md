# 功能規格: 超級管理員系統管理

**功能分支**: `006-super-admin`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "讓超級管理員管理系統使用者權限、標籤設定、平台設定"

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 管理使用者權限 (優先順序: P1)

超級管理員希望授予或撤銷使用者的管理員權限,以控制誰可以審核地點與回報。

**為何此優先順序**: 憲章的 Security by Default 原則要求嚴格的權限控制。這是平台安全性的基礎。

**獨立測試**: 可以透過查看使用者列表並執行權限變更操作來完全測試。

**驗收場景**:

1. **假設** 超級管理員登入系統, **當** 前往超級管理後台, **則** 看到「使用者管理」頁面
2. **假設** 在使用者管理頁面, **當** 查看列表, **則** 顯示所有已註冊使用者,包含:Email、顯示名稱、註冊日期、角色(一般/管理員/超級管理員)
3. **假設** 超級管理員選擇一般使用者, **當** 點擊「授予管理員權限」, **則** 透過 Cloud Function 更新 Custom Claims(`isAdmin: true`),並記錄操作
4. **假設** 超級管理員選擇管理員, **當** 點擊「撤銷管理員權限」, **則** 透過 Cloud Function 移除 Custom Claims(`isAdmin: false`),並記錄操作
5. **假設** 權限變更完成, **當** 目標使用者下次登入, **則** 自動取得或失去管理員權限
6. **假設** 超級管理員嘗試撤銷自己的權限, **當** 執行操作, **則** 系統阻止並顯示錯誤訊息「無法撤銷自己的超級管理員權限」
7. **假設** 系統中只有一位超級管理員, **當** 嘗試撤銷, **則** 系統阻止並顯示錯誤訊息「系統必須至少保留一位超級管理員」

---

### 使用者故事 2 - 管理綠活標籤 (優先順序: P1)

超級管理員希望新增、編輯或刪除綠活標籤,以適應不斷變化的分類需求。

**為何此優先順序**: 標籤是平台核心分類系統,必須由超級管理員統一管理以保持一致性。

**獨立測試**: 可以透過查看標籤列表並執行新增/編輯/刪除操作來完全測試。

**驗收場景**:

1. **假設** 超級管理員登入系統, **當** 前往超級管理後台, **則** 看到「標籤管理」頁面
2. **假設** 在標籤管理頁面, **當** 查看列表, **則** 顯示所有標籤,包含:標籤名稱、使用次數(有多少地點使用此標籤)、建立時間
3. **假設** 超級管理員點擊「新增標籤」, **當** 填寫表單, **則** 要求輸入標籤名稱(必填,3-20 字元)
4. **假設** 超級管理員提交新標籤, **當** 資料送出, **則** 在 Firestore `tags` 集合建立新文件,並顯示成功訊息
5. **假設** 超級管理員編輯標籤, **當** 修改標籤名稱, **則** 更新 Firestore 文件,並即時反映在所有使用該標籤的地點
6. **假設** 超級管理員刪除標籤, **當** 點擊「刪除」, **則** 顯示確認對話框「此標籤被 X 個地點使用,確定刪除?」
7. **假設** 超級管理員確認刪除, **當** 執行操作, **則** 刪除標籤並從所有地點的 `tagIds` 陣列中移除該標籤 ID
8. **假設** 標籤仍被地點使用, **當** 嘗試刪除, **則** 可選擇「強制刪除」或「取消」

---

### 使用者故事 3 - 查看系統日誌 (優先順序: P2)

超級管理員希望查看所有管理員操作記錄,以監控系統使用情況與稽核。

**為何此優先順序**: 提供重要的稽核功能,但不阻礙核心管理功能。可在基本權限管理完成後實作。

**驗收場景**:

1. **假設** 超級管理員登入系統, **當** 前往超級管理後台, **則** 看到「系統日誌」頁面
2. **假設** 在系統日誌頁面, **當** 查看列表, **則** 顯示所有管理員操作記錄,按時間倒序排列
3. **假設** 查看日誌項目, **當** 展開詳情, **則** 顯示:操作類型、操作者、目標、時間、詳細資訊
4. **假設** 超級管理員使用篩選, **當** 選擇操作類型或時間範圍, **則** 即時更新列表
5. **假設** 日誌記錄超過 1000 筆, **當** 捲動到底部, **則** 自動載入下一頁(無限捲動)

---

### 使用者故事 4 - 管理平台設定 (優先順序: P3)

超級管理員希望調整平台設定(例如:預設地圖中心、審核時限),以靈活適應營運需求。

**為何此優先順序**: 提供營運靈活性,但可以先使用硬編碼的預設值。未來再實作動態設定。

**驗收場景**:

1. **假設** 超級管理員登入系統, **當** 前往超級管理後台, **則** 看到「平台設定」頁面
2. **假設** 在平台設定頁面, **當** 查看設定項目, **則** 顯示:預設地圖中心(經緯度)、預設縮放層級、審核時限(天數)、每日上傳限制
3. **假設** 超級管理員修改設定, **當** 儲存變更, **則** 更新 Firestore `platform_settings` 文件,並即時生效
4. **假設** 設定值不合理(例如:負數), **當** 嘗試儲存, **則** 顯示驗證錯誤訊息

---

### 邊界情況

- 當超級管理員撤銷唯一管理員的權限時會怎樣(導致沒有人能審核)?
- 如何處理刪除標籤時有大量地點使用的情況(效能問題)?
- 當超級管理員帳號被盜用時如何應對?
- 如何防止誤操作(例如:誤刪重要標籤)?
- 當使用者列表超過 10,000 人時,查詢效能如何?
- 如何處理 Custom Claims 更新失敗的情況?
- 當系統日誌累積過多時如何清理?

## 需求 *(必填)*

### 功能需求

#### 使用者權限管理

- **FR-001**: 系統必須限制只有擁有 `isSuperAdmin: true` Custom Claim 的使用者可以存取超級管理後台
- **FR-002**: 系統必須在超級管理後台顯示所有已註冊使用者列表
- **FR-003**: 使用者列表必須顯示:Email、顯示名稱、註冊日期、角色(一般/管理員/超級管理員)、是否為荒野夥伴
- **FR-004**: 超級管理員必須能夠授予使用者管理員權限,透過 Cloud Function 更新 Custom Claims(`isAdmin: true`)
- **FR-005**: 超級管理員必須能夠撤銷使用者的管理員權限,透過 Cloud Function 移除 Custom Claims(`isAdmin: false`)
- **FR-006**: 系統必須阻止超級管理員撤銷自己的超級管理員權限
- **FR-007**: 系統必須確保至少保留一位超級管理員(若只有一位則無法撤銷)
- **FR-008**: 系統必須記錄所有權限變更操作到 `admin_logs` 集合
- **FR-009**: 系統必須支援使用者列表的搜尋功能(依 Email 或顯示名稱)
- **FR-010**: 系統必須支援使用者列表的篩選功能(依角色、荒野夥伴身份)

#### 標籤管理

- **FR-011**: 系統必須在超級管理後台顯示所有綠活標籤列表
- **FR-012**: 標籤列表必須顯示:標籤名稱、使用次數(統計有多少地點使用)、建立時間
- **FR-013**: 超級管理員必須能夠新增標籤,要求輸入標籤名稱(3-20 字元)
- **FR-014**: 超級管理員必須能夠編輯標籤名稱
- **FR-015**: 超級管理員必須能夠刪除標籤,若標籤被使用則顯示確認對話框
- **FR-016**: 系統必須在刪除標籤時,從所有地點的 `tagIds` 陣列中移除該標籤 ID
- **FR-017**: 系統必須驗證標籤名稱唯一性(不允許重複)
- **FR-018**: 系統必須記錄所有標籤變更操作到 `admin_logs` 集合

#### 系統日誌

- **FR-019**: 系統必須在超級管理後台顯示所有管理員操作記錄(從 `admin_logs` 集合)
- **FR-020**: 日誌列表必須顯示:操作類型、操作者、目標、時間、詳細資訊
- **FR-021**: 日誌列表必須按時間倒序排列(最新的在最上面)
- **FR-022**: 系統必須支援日誌篩選:依操作類型、操作者、時間範圍
- **FR-023**: 系統必須支援無限捲動或分頁載入(避免一次載入過多記錄)
- **FR-024**: 系統必須限制日誌查詢範圍為最近 90 天(避免效能問題)

#### 平台設定

- **FR-025**: 系統必須在 Firestore `platform_settings` 文件儲存平台設定
- **FR-026**: 超級管理員必須能夠修改設定項目:預設地圖中心(經緯度)、預設縮放層級、審核時限(天數)
- **FR-027**: 系統必須驗證設定值的合理性(例如:緯度 -90~90、經度 -180~180、縮放層級 1-20)
- **FR-028**: 系統必須在設定更新後即時生效(透過 Firestore realtime listener)
- **FR-029**: 系統必須記錄所有設定變更操作到 `admin_logs` 集合

### 關鍵實體

- **Platform Settings (平台設定)**: Firestore `/platform_settings/config`,包含:
  - `defaultMapCenter`: GeoPoint(預設地圖中心)
  - `defaultZoomLevel`: 數字(預設縮放層級)
  - `reviewDeadlineDays`: 數字(審核時限,天數)
  - `maxDailyUploads`: 數字(每位使用者每日上傳限制)
  - `updatedAt`: 最後更新時間
  - `updatedBy`: 更新者 User ID

- **Tag (標籤)**: Firestore `/tags/{tagId}`,包含:
  - `name`: 標籤名稱
  - `createdAt`: 建立時間
  - `createdBy`: 建立者 User ID
  - `updatedAt`: 最後更新時間(若有編輯)
  - `usage`: 使用次數(由 Cloud Function 自動計算,或客戶端查詢時計算)

- **Admin Action Log**: 新增超級管理員操作類型:
  - `grant_admin` | `revoke_admin` | `create_tag` | `update_tag` | `delete_tag` | `update_settings`

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 超級管理員授予或撤銷權限的操作在 3 秒內完成(含 Cloud Function 執行)
- **SC-002**: 使用者列表載入時間小於 3 秒(最多 1000 筆記錄)
- **SC-003**: 標籤管理操作(新增/編輯/刪除)在 2 秒內完成
- **SC-004**: 刪除標籤時,從所有地點移除的操作在 5 秒內完成(假設 100 個地點使用該標籤)
- **SC-005**: 系統日誌查詢在 2 秒內返回結果(90 天內最多 10,000 筆記錄)
- **SC-006**: 平台設定更新後,所有客戶端在 5 秒內自動套用新設定
- **SC-007**: 使用者搜尋回應時間小於 1 秒
- **SC-008**: 超級管理後台載入時間小於 3 秒
- **SC-009**: 權限變更成功率達到 99.9% 以上
- **SC-010**: 系統必須支援至少 10,000 位使用者的管理而不影響效能

## 假設與限制

### 假設

- 超級管理員擁有技術背景,理解權限管理的影響
- 超級管理員帳號由系統初始化時手動建立(透過 Firebase CLI 或 Console)
- 平台初期使用者數量不會超過 10,000 人
- 標籤數量不會超過 100 個
- 超級管理員定期監控系統日誌

### 技術限制

- Custom Claims 更新需要透過 Cloud Function(無法從前端直接更新)
- Custom Claims 更新後,使用者需要重新登入才能生效
- Firestore 查詢大量使用者時可能有效能問題(需要分頁或索引最佳化)
- 刪除標籤時,若有大量地點使用,可能需要批次處理(Cloud Function 背景執行)
- 系統日誌累積過多時需要定期清理或歸檔

### 業務限制

- 超級管理員帳號由系統初始化時手動建立(無自助註冊)
- 不支援多層級權限系統(只有一般、管理員、超級管理員三級)
- 平台設定項目有限,不支援自訂設定欄位
- 不支援權限變更的審批流程(超級管理員可直接執行)

## 相依性

### 前置條件

- 使用者認證系統已完成(Epic 2)
- 管理員審核系統已完成(Epic 5)
- Firebase Custom Claims 機制已理解與配置
- Cloud Functions 已部署用於 Custom Claims 更新
- Firestore 安全規則已配置超級管理員存取權限
- 初始超級管理員帳號已手動建立(透過 Firebase CLI)
- `tags` 集合已初始化預設標籤
- `platform_settings` 文件已初始化預設設定

### 外部相依

- Firebase Firestore (必要)
- Firebase Auth with Custom Claims (必要)
- Firebase Cloud Functions (必要)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- 多層級權限系統(例如:地區管理員、分類管理員)
- 權限變更審批流程
- 批次使用者管理(批次授予/撤銷權限)
- 使用者活動追蹤與分析
- 自動化標籤建議(基於使用者提交的地點描述)
- 標籤合併功能(將重複標籤合併)
- 平台設定版本控制與回滾
- 系統日誌匯出功能(CSV/JSON)
- 系統健康監控儀表板
- 自動化系統維護任務(例如:清理過期資料)
- 超級管理員雙因素驗證(2FA)強制要求
- IP 白名單限制(只允許特定 IP 存取超級管理後台)
