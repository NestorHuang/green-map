# 功能規格: 使用者認證與個人檔案

**功能分支**: `002-user-auth`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "實作安全的使用者認證系統與個人檔案管理,支援荒野夥伴身份驗證"

## Clarifications

### Session 2025-12-02

- Q: Email 驗證機制應該覆蓋哪些功能?目前規格提到「無法提交地點」,但其他功能(如查看地圖、回報錯誤)是否也需要驗證? → A: 僅限制內容貢獻功能需要 Email 驗證(提交新地點),其他功能如瀏覽地圖、回報錯誤、編輯個人檔案等無需驗證,以平衡安全性與使用者體驗
- Q: 荒野編號的驗證應該如何進行?目前規格僅提到「管理員審核」,但沒有說明管理員如何驗證編號的真實性。 → A: 荒野編號僅作為使用者輸入欄位,系統不進行格式或真實性驗證,完全信任使用者自行填寫正確資訊,以降低系統複雜度並尊重社群自律
- Q: 使用者上傳的頭像應該如何處理?目前規格僅說明「儲存到 Firebase Storage」,但沒有說明是否需要壓縮、裁切或產生縮圖。 → A: 壓縮 + 強制正方形裁切 + 產生多尺寸縮圖,確保最佳效能與一致的視覺呈現,雖實作較複雜但提供專業體驗

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - Email 註冊登入 (優先順序: P1)

一般使用者希望透過 Email 註冊帳號,以便提交綠色生活地點並參與社群。

**為何此優先順序**: 這是使用者從訪客轉變為貢獻者的關鍵功能,是平台互動性的基礎。

**獨立測試**: 可以透過完整的註冊流程測試,驗證帳號建立、Email 驗證、登入功能。

**驗收場景**:

1. **假設** 新使用者造訪網站, **當** 點擊「註冊」按鈕, **則** 顯示註冊表單要求輸入 Email、密碼、顯示名稱
2. **假設** 使用者填寫完整表單, **當** 提交註冊, **則** Firebase Auth 建立帳號並發送驗證 Email
3. **假設** 帳號建立成功, **當** Email 驗證完成前, **則** 使用者可以登入但無法提交地點,並顯示提示訊息要求驗證 Email
4. **假設** 使用者點擊驗證 Email 中的連結, **當** 驗證成功, **則** 使用者可以完整使用所有登入使用者功能
5. **假設** 已註冊使用者, **當** 在登入頁面輸入正確的 Email 和密碼, **則** 成功登入並跳轉到地圖頁面
6. **假設** 使用者輸入錯誤密碼, **當** 嘗試登入, **則** 顯示錯誤訊息「Email 或密碼錯誤」

---

### 使用者故事 2 - 荒野夥伴身份驗證 (優先順序: P1)

荒野夥伴希望驗證自己的身份,以獲得夥伴專屬功能(例如:地點優先核准)。

**為何此優先順序**: 憲章的 Community-First Development 原則要求優先支持荒野夥伴,這是實現此原則的關鍵。

**獨立測試**: 可以透過提交荒野編號並由管理員驗證來完全測試流程。

**驗收場景**:

1. **假設** 已登入的一般使用者, **當** 前往個人檔案頁面, **則** 看到「填寫荒野夥伴資訊」按鈕
2. **假設** 使用者點擊填寫按鈕, **當** 顯示資訊表單, **則** 要求輸入荒野編號、所屬分會、自然名
3. **假設** 使用者提交荒野夥伴資訊, **當** 資料送出, **則** 立即更新使用者的 Custom Claims(`isWildernessPartner: true`)並儲存荒野夥伴資訊到個人檔案
4. **假設** 使用者完成填寫, **當** 返回個人檔案, **則** 顯示荒野夥伴徽章與資訊(荒野編號、分會、自然名)
5. **假設** 已填寫的荒野夥伴, **當** 提交地點資訊, **則** 自動使用「團名-自然名」格式作為登錄者顯示名稱
6. **假設** 荒野夥伴想修改資訊, **當** 編輯個人檔案, **則** 可以更新荒野編號、分會或自然名

---

### 使用者故事 3 - 個人檔案管理 (優先順序: P2)

已登入使用者希望編輯個人檔案,以更新顯示名稱或頭像。

**為何此優先順序**: 是良好的使用者體驗,但不阻礙核心功能(提交地點)。可在基本認證功能完成後實作。

**驗收場景**:

1. **假設** 已登入使用者, **當** 前往個人檔案頁面, **則** 顯示當前的個人資訊(顯示名稱、Email、頭像)
2. **假設** 使用者點擊「編輯檔案」按鈕, **當** 進入編輯模式, **則** 可以修改顯示名稱和上傳新頭像
3. **假設** 使用者上傳新頭像, **當** 選擇圖片檔案, **則** 顯示裁切工具要求裁切為正方形(1:1比例),並限制檔案大小為 2MB 以下
4. **假設** 使用者完成裁切, **當** 確認上傳, **則** 系統壓縮並產生三種尺寸縮圖(32x32、128x128、512x512)
5. **假設** 使用者儲存變更, **當** 提交表單, **則** 更新 Firestore 使用者文件並顯示成功訊息
5. **假設** 使用者未驗證 Email, **當** 查看個人檔案, **則** 顯示警告橫幅與「重新發送驗證 Email」按鈕

---

### 使用者故事 4 - 查看我的提交記錄 (優先順序: P2)

已登入使用者希望查看自己提交過的地點列表,以追蹤提交狀態。

**為何此優先順序**: 提供重要的回饋機制,但不阻礙提交功能本身。可在基本提交功能完成後實作。

**驗收場景**:

1. **假設** 已登入使用者, **當** 前往個人檔案頁面, **則** 顯示「我的提交」標籤
2. **假設** 使用者點擊標籤, **當** 載入提交列表, **則** 顯示所有由該使用者提交的地點(包含待審核、已核准、已拒絕)
3. **假設** 列表中有多個地點, **當** 查看每個項目, **則** 顯示地點名稱、提交時間、審核狀態、操作按鈕(查看/編輯)
4. **假設** 使用者點擊待審核的地點, **當** 進入編輯模式, **則** 可以修改地點資訊並重新提交
5. **假設** 使用者查看已拒絕的地點, **當** 展開詳情, **則** 顯示管理員拒絕的原因

---

### 邊界情況

- 當使用者的 Email 已經被註冊時會怎樣? → Firebase Auth 自動處理並顯示錯誤訊息
- 如何處理 Email 驗證連結過期的情況? → 顯示「驗證連結已過期」訊息，提供「重新發送驗證 Email」按鈕，成功後顯示提示訊息「驗證 Email 已重新發送，請查收信箱」
- 如果使用者上傳的頭像不是圖片格式會怎樣? → Storage Rules 限制僅允許 image/jpeg 和 image/png，前端也應驗證檔案類型並顯示友善錯誤
- 當使用者快速連續點擊「重新發送驗證 Email」按鈕時如何防止濾用? → localStorage 1 分鐘限流，登出/過期自動清除
- 使用者在荒野夥伴表單填寫一半放棄時怎麼辦? → 不儲存草稿，離開頁面即清除輸入，避免 localStorage 殘留資料
- 頭像上傳過程中網路中斷時怎麼辦? → 顯示錯誤訊息並提供「重試」按鈕
- 使用者同時在多個裝置登入編輯個人檔案時怎麼辦? → Firestore 最後寫入覆蓋，不實作樂觀鎖（簡化設計）
- 提交記錄超過 100 筆分頁載入時怎麼辦? → 使用 Firestore Query 的 `limit()` 和 `startAfter()` 實作分頁或無限滾動

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須支援使用 Email 和密碼註冊新帳號
- **FR-002**: 系統必須在註冊時驗證 Email 格式與密碼強度(至少 6 字元)
- **FR-003**: 系統必須在註冊後自動發送 Email 驗證信
- **FR-004**: 系統必須限制未驗證 Email 的使用者無法提交地點資訊,但允許瀏覽地圖、回報錯誤、編輯個人檔案等其他功能
- **FR-005**: 系統必須支援使用 Email 和密碼登入
- **FR-006**: 系統必須在登入失敗時顯示通用錯誤訊息(不透露 Email 是否存在)
- **FR-007**: 系統必須在使用者登入後建立或更新 Firestore 中的使用者文件
- **FR-008**: 系統必須提供「忘記密碼」功能,透過 Firebase Auth 發送重設連結
- **FR-009**: 系統必須支援使用者填寫荒野夥伴資訊,要求輸入:荒野編號（1-50 字元）、所屬分會（1-30 字元）、自然名（2-20 字元）,不進行格式模式或真實性驗證,僅驗證長度限制
- **FR-010**: 系統必須在使用者填寫荒野夥伴資訊後,立即更新使用者的 Custom Claims(`isWildernessPartner: true`)並儲存資訊到使用者文件
- **FR-011**: 系統必須允許荒野夥伴編輯自己的荒野夥伴資訊(編號、分會、自然名)
- **FR-012**: 系統必須允許使用者編輯個人檔案：顯示名稱 (displayName)、頭像 (photoURL)
- **FR-013**: 系統必須限制頭像上傳檔案大小為 2MB,格式為 JPEG/PNG,並要求使用者裁切為正方形(1:1比例)
- **FR-014**: 系統必須在上傳時自動壓縮頭像並產生三種尺寸:32x32(小頭像)、128x128(中頭像)、512x512(大頭像)
- **FR-015**: 系統必須將原圖與三種縮圖儲存到 Firebase Storage 的 `avatars/{userId}/` 路徑,檔名分別為 `original.jpg`、`small.jpg`、`medium.jpg`、`large.jpg`
- **FR-016**: 系統必須提供「重新發送驗證 Email」功能,並限制 1 分鐘內最多發送 1 次
- **FR-017**: 系統必須顯示使用者提交的所有地點列表,包含狀態篩選
- **FR-018**: 系統必須允許使用者編輯自己提交的待審核地點（在「我的提交」列表中，待審核地點顯示「編輯」按鈕，點擊後導向地點提交表單並預填現有資料，提交後更新 Firestore 中的 pending_locations 文件）
- **FR-004-NOTE**: 未驗證 Email 限制提交地點的檢查將在 Epic 003（地點貢獻）中實作，於地點提交表單中加入 `if (!user.emailVerified)` 檢查並顯示錯誤訊息，同時在 Firestore Security Rules 中雙重驗證
- **FR-019**: 系統必須在使用者登出時清除前端的驗證狀態
- **FR-020**: 系統必須根據顯示情境自動選擇適當的頭像尺寸：小頭像列表/縮略圖使用 small.jpg (32x32)、個人檔案頁面使用 medium.jpg (128x128)、全螢幕查看使用 large.jpg (512x512),各 UI 元件應明確指定所需尺寸

### 關鍵實體 *(包含因為功能涉及資料)*

- **User Document (使用者文件)**: Firestore 中的 `/users/{userId}`,包含:
  - `displayName`: 顯示名稱
  - `email`: Email 地址
  - `emailVerified`: Email 驗證狀態
  - `photoURL`: 頭像 URL
  - `isWildernessPartner`: 是否為荒野夥伴(同步自 Custom Claims)
  - `wildernessInfo`: 荒野夥伴資訊(編號、分會、自然名、驗證狀態)
  - `createdAt`: 註冊時間
  - `updatedAt`: 最後更新時間

- **Wilderness Partner Info (荒野夥伴資訊)**: 嵌入在 User Document 的 `wildernessInfo` 欄位,包含:
  - `wildernessId`: 荒野編號(使用者自行填寫,無驗證)
  - `chapter`: 所屬分會
  - `natureName`: 自然名
  - `filledAt`: 填寫時間
  - `updatedAt`: 最後更新時間

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 註冊流程從開始填寫到帳號建立成功,整個過程在10秒內完成
- **SC-002**: Email 驗證信在使用者註冊後60秒內送達
- **SC-003**: 登入流程(輸入帳密到跳轉地圖頁)在3秒內完成
- **SC-004**: 荒野夥伴資訊填寫後,Custom Claims 更新在 2 秒內完成（從 Cloud Function 調用到 Token 重新整理並在前端 AuthContext 生效的完整時間）
- **SC-005**: 頭像上傳、壓縮與產生三種縮圖在 8 秒內完成(2MB 原圖)
- **SC-006**: 個人檔案頁面載入時間小於 2 秒(使用 medium 尺寸頭像)
- **SC-007**: 使用者提交列表支援至少 100 筆記錄的流暢載入
- **SC-008**: 密碼重設 Email 在 2 分鐘內送達
- **SC-009**: 95% 的使用者能在首次嘗試時成功註冊與登入(透過使用者測試驗證)
- **SC-010**: 登入驗證錯誤時,系統回應時間小於 1 秒

## 假設與限制

### 假設

- 使用者有有效的 Email 信箱且能接收驗證信
- 荒野夥伴擁有有效的荒野編號
- Firebase Auth 已正確配置且啟用 Email/Password 提供者
- Firebase Storage 已啟用且有足夠儲存空間
- 使用者理解 Email 驗證的重要性

### 技術限制

- Firebase Auth Email 驗證連結有效期限為 24 小時
- Firebase Storage 免費層容量為 5GB
- 頭像上傳限制為 2MB(避免過長的上傳時間)
- 頭像處理需要前端裁切工具(如 react-image-crop)與後端壓縮函式庫(如 Sharp 於 Cloud Functions)
- 密碼強度最低要求為 6 字元(Firebase Auth 限制)
- Custom Claims 大小限制為 1000 bytes

### 業務限制

- 荒野夥伴資訊完全基於使用者自律填寫,系統不驗證編號真實性
- 僅支援 Email/Password 認證(未來可擴展 Google OAuth)
- 所有使用者資料儲存在台灣區域的 Firestore
- 不支援使用者刪除帳號功能(需聯絡管理員)

## 相依性

### 前置條件

- Firebase Auth 已啟用 Email/Password 提供者
- Firebase Firestore 安全規則已配置使用者文件存取權限
- Firebase Storage 安全規則已配置頭像上傳權限
- Email 驗證範本已自訂(可選,使用預設範本亦可)
- Cloud Functions 已部署用於更新 Custom Claims(荒野夥伴資訊填寫時)
- Cloud Functions 已部署用於頭像壓縮與縮圖產生(使用 Sharp 或類似函式庫)
- 前端已整合圖片裁切工具(如 react-image-crop 或 react-easy-crop)

### 外部相依

- Firebase Authentication (必要)
- Firebase Firestore (必要)
- Firebase Storage (P2 功能需要)
- Firebase Cloud Functions (荒野夥伴 Custom Claims 更新需要、頭像處理需要)
- Sharp 或類似圖片處理函式庫(Cloud Functions 中用於壓縮與產生縮圖)
- 前端圖片裁切函式庫(如 react-image-crop)
- Email 發送服務(Firebase 內建)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- Google OAuth 登入
- Facebook OAuth 登入
- 雙因素驗證(2FA)
- 使用者帳號刪除功能
- 匯出個人資料(GDPR 合規)
- 通知設定管理
- 隱私設定(控制個人檔案可見性)
- 使用者封鎖與檢舉功能
- 密碼強度即時驗證與提示
- 登入裝置管理(查看所有登入裝置)
