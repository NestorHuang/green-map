# 功能規格: 地點提交與貢獻

**功能分支**: `003-location-contribution`  
**建立日期**: 2025-12-02  
**狀態**: 草稿  
**輸入**: 使用者描述: "讓已登入使用者提交新的綠色生活地點資訊,並經過管理員審核後顯示在地圖上"

## Clarifications

### Session 2025-12-02

- Q: 重複地點的偵測應該如何進行?目前規格提到「相同地址」會顯示警告但允許提交,但沒有說明如何判定「相同」,以及警告訊息應包含哪些資訊。 → A: 不進行重複地點偵測,因為同一地點可能有不同的使用者回應與體驗(如不同時間的營業狀況、不同角度的評價),所有提交都視為獨立記錄,由管理員在審核時判斷是否合併或保留多筆
- Q: 當照片上傳失敗時(如網路中斷、檔案過大、Storage 限制),應該如何處理?目前規格未說明失敗後的使用者體驗與資料完整性。 → A: 允許部分成功提交,至少 1 張照片成功上傳即可提交地點,失敗的照片顯示明確錯誤訊息(含失敗原因),使用者可選擇移除失敗照片後繼續提交或重新上傳

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 提交新地點 (優先順序: P1)

已登入使用者希望提交新發現的綠色生活地點,以分享給社群並豐富平台內容。

**為何此優先順序**: 這是平台的核心價值主張 - 社群協作建立綠色生活地圖。沒有此功能,平台無法成長。

**獨立測試**: 可以透過完整的地點提交流程測試,從填寫表單到資料儲存到 Firestore。

**驗收場景**:

1. **假設** 已登入且 Email 已驗證的使用者, **當** 點擊「新增地點」按鈕, **則** 顯示地點提交表單
2. **假設** 使用者填寫表單, **當** 輸入地點資訊, **則** 要求提供:地點名稱、地址、描述、綠活標籤、照片(至少 1 張)
3. **假設** 使用者輸入地址, **當** 選擇 Google Places 建議的地址, **則** 自動填入經緯度座標
4. **假設** 使用者上傳照片, **當** 選擇圖片檔案, **則** 預覽圖片並限制每張檔案大小為 5MB,最多 5 張
5. **假設** 某些照片上傳失敗, **當** 上傳過程中發生錯誤, **則** 顯示失敗照片的錯誤訊息(如「檔案過大」、「網路中斷」、「不支援的格式」),並允許移除失敗照片或重新上傳
6. **假設** 使用者選擇綠活標籤, **當** 點擊標籤選項, **則** 可以多選(至少選擇 1 個,最多 5 個)
7. **假設** 表單填寫完整且至少 1 張照片成功上傳, **當** 提交地點資訊, **則** 資料儲存到 Firestore `locations` 集合,狀態為 `pending`,並顯示成功訊息
8. **假設** 提交者為荒野夥伴, **當** 提交地點, **則** 自動使用「團名-自然名」格式作為登錄者顯示
9. **假設** 提交成功, **當** 返回地圖頁面, **則** 新地點不會立即顯示(需等待管理員核准)
10. **假設** 使用者填寫表單中途關閉頁面或導航離開, **當** 再次開啟提交表單, **則** 自動恢復上次未完成的表單資料(包含文字欄位與已選擇的標籤,但不包含照片)
11. **假設** 使用者成功提交地點後, **當** 再次開啟提交表單, **則** 清除之前的暫存草稿,顯示空白表單

---

### 使用者故事 2 - 編輯待審核地點 (優先順序: P1)

已登入使用者希望在地點審核前編輯自己提交的資訊,以修正錯誤或補充細節。

**為何此優先順序**: 避免因小錯誤導致地點被拒絕,減少管理員負擔與使用者挫折感。

**獨立測試**: 可以透過提交地點後立即編輯來測試,驗證資料是否正確更新。

**驗收場景**:

1. **假設** 使用者有待審核的地點, **當** 在個人檔案查看提交列表, **則** 看到「編輯」按鈕
2. **假設** 使用者點擊編輯按鈕, **當** 進入編輯頁面, **則** 預填現有資料並允許修改
3. **假設** 使用者修改資訊, **當** 提交變更, **則** 更新 Firestore 文件並記錄編輯時間
4. **假設** 地點已被核准或拒絕, **當** 使用者嘗試編輯, **則** 顯示「無法編輯」訊息並說明原因

---

### 使用者故事 3 - 查看提交狀態通知 (優先順序: P2)

已登入使用者希望在地點被核准或拒絕時收到通知,以了解提交結果。

**為何此優先順序**: 提供良好的回饋機制,但不阻礙核心提交功能。可在基本提交功能穩定後實作。

**驗收場景**:

1. **假設** 管理員核准使用者提交的地點, **當** 狀態更新為 `approved`, **則** 使用者在下次登入時看到通知
2. **假設** 管理員拒絕地點, **當** 狀態更新為 `rejected`, **則** 通知包含拒絕原因
3. **假設** 使用者點擊通知, **當** 查看詳情, **則** 跳轉到該地點的詳情頁面或編輯頁面(若被拒絕)
4. **假設** 使用者有多個未讀通知, **當** 查看通知列表, **則** 按時間倒序排列

---

### 邊界情況

- 如何處理使用者上傳不適當的照片(例如:非地點相關、色情、暴力)?
- 當使用者提交時網路中斷會怎樣?
- 當所有照片都上傳失敗時如何處理?
- 如何處理照片上傳到一半時使用者離開頁面?
- 如果地址無法取得正確的經緯度座標會怎樣?
- 當使用者快速連續提交多個地點時如何防止濫用?
- 如何處理極長的地點描述(超過 1000 字)?
- 當使用者關閉瀏覽器但表單未提交時,資料是否保留?
- 表單中途關閉時,未完成的資料是否保留?
- 草稿資料保留多久?(session 期間或永久?)
- 照片是否納入草稿自動儲存範圍?
- 成功提交後是否自動清除草稿?

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須限制只有已登入且 Email 已驗證的使用者可以提交地點
- **FR-002**: 系統必須提供地點提交表單,包含欄位:名稱、地址、描述、標籤、照片
- **FR-003**: 系統必須整合 Google Places API 提供地址自動完成功能
- **FR-004**: 系統必須在使用者選擇地址後,使用 Geocoding API 取得經緯度座標
- **FR-005**: 系統必須驗證必填欄位:名稱、地址、描述、至少 1 個標籤、至少 1 張照片
- **FR-006**: 系統必須限制地點名稱長度為 3-100 字元
- **FR-007**: 系統必須限制地點描述長度為 10-1000 字元
- **FR-008**: 系統必須限制照片上傳數量為 1-5 張,每張檔案大小最大 5MB,格式限制為 JPEG/PNG
- **FR-009**: 系統必須在照片上傳失敗時顯示明確錯誤訊息,包含失敗原因(檔案過大、不支援的格式、網路錯誤、Storage 限制等)
- **FR-010**: 系統必須允許使用者移除上傳失敗的照片,或重新上傳以替換失敗的照片
- **FR-011**: 系統必須在至少 1 張照片成功上傳後才允許提交地點,若所有照片都失敗則禁止提交並顯示錯誤提示
- **FR-012**: 系統必須限制標籤選擇數量為 1-5 個
- **FR-013**: 系統必須將照片上傳到 Firebase Storage 的 `locations/{locationId}/` 路徑
- **FR-014**: 系統必須在 Firestore `locations` 集合建立新文件,初始狀態為 `pending`
- **FR-015**: 系統必須記錄提交者資訊:使用者 ID、顯示名稱、是否為荒野夥伴、提交時間
- **FR-016**: 系統必須為荒野夥伴自動填入「團名-自然名」格式的登錄者顯示
- **FR-017**: 系統必須允許使用者編輯自己提交且狀態為 `pending` 的地點
- **FR-018**: 系統必須在使用者編輯地點時更新 `updatedAt` 時間戳記
- **FR-019**: 系統必須限制使用者只能編輯自己提交的地點(透過 Firestore 安全規則)
- **FR-020**: 系統必須在地點被核准後禁止編輯(狀態為 `approved` 或 `rejected`)
- **FR-021**: 系統必須在提交成功後顯示確認訊息,並提供「繼續新增」或「返回地圖」選項
- **FR-022**: 系統必須在使用者關閉或離開提交表單時,自動將表單資料(名稱、地址、經緯度、描述、已選標籤)儲存到瀏覽器 localStorage
- **FR-023**: 系統必須在使用者開啟提交表單時,自動檢查並恢復 localStorage 中的草稿資料;照片不納入草稿範圍
- **FR-024**: 系統必須在地點成功提交後,清除 localStorage 中對應的草稿資料
- **FR-025**: 系統必須限制相同 Firebase UID 使用者每日最多提交 10 個新地點

### 關鍵實體 *(包含因為功能涉及資料)*

- **Location Submission (地點提交)**: Firestore `/locations/{locationId}`,包含:
  - `name`: 地點名稱
  - `address`: 地址文字
  - `coordinates`: GeoPoint(經度, 緯度)
  - `description`: 地點描述
  - `tagIds`: 標籤 ID 陣列
  - `photoURLs`: 照片 URL 陣列
  - `status`: `pending` | `approved` | `rejected`
  - `submittedBy`: 提交者 User ID
  - `submitterInfo`: 嵌入物件(顯示名稱、是否為荒野夥伴、團名-自然名)
  - `createdAt`: 提交時間
  - `updatedAt`: 最後更新時間
  - `reviewedAt`: 審核時間(若已審核)
  - `reviewedBy`: 審核者 User ID(若已審核)
  - `rejectionReason`: 拒絕原因(若被拒絕)

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 使用者從開始填寫表單到提交成功,整個過程在 2 分鐘內完成(含照片上傳)
- **SC-002**: 照片上傳(5MB x 5 張)在 15 秒內完成(4G 網路)
- **SC-003**: 地址自動完成建議在使用者輸入後 1 秒內顯示
- **SC-004**: 經緯度座標取得在地址選擇後 2 秒內完成
- **SC-005**: 表單驗證錯誤即時顯示(無需提交後才顯示)
- **SC-006**: 地點資料儲存到 Firestore 在 3 秒內完成
- **SC-007**: 重複地點檢測在 2 秒內完成
- **SC-008**: 95% 的使用者能在首次嘗試時成功提交地點(透過使用者測試驗證)
- **SC-009**: 提交成功率達到 98% 以上(排除網路中斷等外部因素)
- **SC-010**: 照片預覽載入時間小於 500 毫秒

## 假設與限制

### 假設

- 使用者理解提交的地點需要經過審核
- 使用者擁有地點的合法照片(無版權問題)
- Google Places API 能夠涵蓋台灣南區的大多數地址
- 使用者願意提供詳細的地點描述
- 使用者的網路連線足夠上傳照片

### 技術限制

- Firebase Storage 免費層容量為 5GB
- Google Places API 免費配額有限
- Geocoding API 每日請求次數限制
- 照片上傳依賴使用者網路速度
- Firestore 文件大小限制為 1MB(含所有欄位)

### 業務限制

- 所有地點必須經過管理員審核後才能公開顯示
- 僅支援台灣地區的地點提交
- 不支援使用者刪除已提交的地點(需聯絡管理員)
- 荒野夥伴提交的地點無優先審核(未來可能實作)

## 相依性

### 前置條件

- 使用者認證系統已完成(Epic 2)
- Firebase Firestore `locations` 集合已建立
- Firebase Storage 已配置並啟用
- Google Places API 已啟用
- Google Geocoding API 已啟用
- Firestore 安全規則已配置地點提交權限
- `tags` 集合已包含可選擇的標籤資料

### 外部相依

- Firebase Firestore (必要)
- Firebase Storage (必要)
- Google Places API (必要)
- Google Geocoding API (必要)
- Firebase Auth (使用者身份驗證)
- 使用者的網路連線(檔案上傳)

## 未來擴展

以下功能**不在**此規格範圍內,但已識別為未來可能的擴展:

- 草稿儲存功能(離開頁面前自動儲存)
- 批次上傳多個地點
- 從其他地圖平台匯入地點資料
- 照片自動壓縮與最佳化
- 地點評分與評論系統
- 地點認領功能(商家可認領並管理自己的地點)
- 使用者貢獻排行榜
- 社群投票決定地點優先審核
- AI 輔助偵測不適當內容
- 地點重複檢測自動化(基於經緯度距離)
